<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語音読トレーニング - 英検3級</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>英語音読トレーニング</h1>
            <p class="subtitle">英検3級レベル - 4択問題</p>
        </header>

        <!-- スタート画面 -->
        <div id="start-screen" class="screen active">
            <div class="welcome-box">
                <h2>ようこそ！</h2>
                <p>このアプリでは、英語の文章を音読してから4択問題に答えることで、読解力とスピードを鍛えます。</p>
                <h3>使い方：</h3>
                <ol>
                    <li>英語の文章が表示されます（全5問）</li>
                    <li>「測定開始」ボタンを押して声に出して音読してください</li>
                    <li>4つの選択肢から正しい答えを選びます</li>
                    <li>5問終了後、全問のスコアシートが表示されます</li>
                </ol>

                <!-- プライバシー通知 -->
                <div class="privacy-notice">
                    <p style="font-size: 0.9em; color: #666; line-height: 1.6; margin: 20px 0 10px 0;">
                        ℹ️ このアプリでは、学習データの改善のため、スコアデータ（正解数・時間など）を匿名で収集します。
                        個人を特定できる情報は一切収集しません。
                        <a href="privacy.html" target="_blank" style="color: #667eea;">プライバシーポリシー</a>
                    </p>
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="consent-checkbox" checked style="width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 0.95em;">データ収集に同意する（任意）</span>
                    </label>
                </div>

                <button id="start-btn" class="btn btn-primary" style="margin-top: 20px;">スタート</button>

                <!-- バージョン表示 -->
                <p id="app-version" style="text-align: center; margin-top: 20px; font-size: 0.85em; color: #999;">バージョン: --</p>
            </div>
        </div>

        <!-- 問題画面 -->
        <div id="question-screen" class="screen">
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
            <div class="question-info">
                <span id="question-number">問題 1/5</span>
                <span id="timer" class="timer">0.0秒</span>
            </div>

            <!-- 音読＆解答フェーズ -->
            <div id="reading-phase" class="phase">
                <!-- 測定開始ボタン（最上部） -->
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
                    <button id="start-recording-btn" class="btn btn-primary">📊 測定開始</button>
                    <button id="stop-recording-btn" class="btn btn-danger hidden">⏹ 停止</button>
                </div>
                <p class="instruction" id="reading-instruction">「測定開始」ボタンを押して、文章を声に出して読んでください</p>

                <!-- 1. 文章 -->
                <div class="passage-box">
                    <h2>以下の文章を音読してください：</h2>
                    <div id="passage" class="passage"></div>
                </div>

                <!-- 2. 問題と選択肢 -->
                <div class="question-box">
                    <h3>問題：</h3>
                    <p id="question-text" class="question-text"></p>
                </div>
                <div id="choices" class="choices"></div>

                <!-- 3. 音声認識の状態表示 -->
                <div id="recognition-status" class="recognition-status hidden">
                    <div class="recognition-indicator">
                        <span class="mic-icon">🎤</span>
                        <span id="recognition-text">音声を認識中...</span>
                    </div>
                    <div id="recognized-text" class="recognized-text"></div>
                </div>

                <!-- 4. 音声認識結果の比較表示 -->
                <div id="recognition-result" class="recognition-result hidden">
                    <h3>音読チェック結果：</h3>
                    <div id="comparison-display" class="comparison-display"></div>
                    <div id="recognition-feedback" class="recognition-feedback"></div>
                </div>
            </div>

            <!-- フィードバック表示 -->
            <div id="feedback" class="feedback hidden"></div>
        </div>

        <!-- 結果画面 -->
        <div id="result-screen" class="screen">
            <div class="result-box">
                <h2>お疲れ様でした！</h2>
                <div class="score-display">
                    <div class="score-item">
                        <h3>正解数</h3>
                        <p class="score-value" id="final-score">0/5</p>
                    </div>
                    <div class="score-item">
                        <h3>音読速度</h3>
                        <p class="score-value" id="avg-wpm">0 WPM</p>
                    </div>
                </div>
                <div class="result-details" id="result-details"></div>

                <!-- ユーザーID管理セクション -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 30px; border: 2px solid #667eea;">
                    <h3 style="color: #667eea; margin-bottom: 15px; text-align: center;">📋 あなたのユーザーID</h3>
                    <div id="current-user-id-display" style="text-align: center; margin-bottom: 15px;">
                        <p style="font-size: 0.9em; color: #666; margin-bottom: 10px;">現在のユーザーID：</p>
                        <p style="font-size: 1.1em; font-weight: bold; color: #333; font-family: 'Courier New', monospace; background: white; padding: 10px; border-radius: 5px; word-break: break-all;" id="current-user-id"></p>
                    </div>
                    <div style="text-align: center; margin-bottom: 15px;">
                        <p style="font-size: 0.85em; color: #666; line-height: 1.6;">
                            💡 このIDを保存しておくと、別のブラウザやデバイスでも同じアカウントでスコアを記録できます。<br>
                            IDを入力すると、過去のスコアが表示されます。
                        </p>
                    </div>
                    <div style="display: flex; gap: 10px; align-items: center; justify-content: center; flex-wrap: wrap;">
                        <input type="text" id="user-id-input" placeholder="IDを入力（例: user_abc123_xyz）"
                            style="padding: 10px 15px; font-size: 1em; border: 2px solid #ddd; border-radius: 5px; min-width: 300px; font-family: 'Courier New', monospace;">
                        <button id="load-user-id-btn" class="btn btn-primary" style="padding: 10px 20px;">IDを読み込む</button>
                        <button id="copy-user-id-btn" class="btn btn-secondary" style="padding: 10px 20px;">IDをコピー</button>
                    </div>
                    <div id="user-id-message" style="text-align: center; margin-top: 10px; font-size: 0.9em;"></div>
                </div>

                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 30px;">
                    <button id="restart-btn" class="btn btn-primary" style="font-size: 1.2em; padding: 20px 50px;">もう一度遊ぶ</button>
                </div>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 15px;">
                    <button id="export-csv-btn" class="btn btn-secondary">スコアをCSV出力</button>
                    <button id="view-history-btn" class="btn btn-secondary">履歴を見る</button>
                </div>
            </div>
        </div>

        <!-- スコア履歴画面 -->
        <div id="history-screen" class="screen">
            <div class="result-box">
                <h2>スコア履歴</h2>
                <div id="history-list" class="history-list"></div>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
                    <button id="back-to-start-btn" class="btn btn-primary">トップに戻る</button>
                    <button id="view-progress-btn" class="btn btn-secondary">📊 あなたの推移を見る</button>
                    <button id="export-all-btn" class="btn btn-secondary">全履歴をCSV出力</button>
                    <button id="clear-history-btn" class="btn btn-danger">履歴を削除</button>
                </div>
            </div>
        </div>

        <!-- スコア推移画面 -->
        <div id="progress-screen" class="screen">
            <div class="result-box">
                <h2>📈 あなたのスコア推移</h2>
                <div id="user-id-display" style="text-align: center; margin: 20px 0; color: #666; font-size: 0.9em;"></div>
                <div id="progress-chart" style="margin: 30px 0;"></div>
                <div id="progress-stats" style="margin: 30px 0;"></div>
                <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-top: 20px;">
                    <button id="back-to-history-btn" class="btn btn-primary">履歴に戻る</button>
                </div>
            </div>
        </div>

        <!-- ローディング表示 -->
        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>問題を生成中...</p>
        </div>
    </div>

    <script type="module" src="app.js"></script>
</body>
</html>
